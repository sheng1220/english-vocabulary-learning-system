<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡è½å¯«è€ƒè©¦ç³»çµ± (æ‰‹æ©Ÿå„ªåŒ–ç‰ˆ)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }
        
        .page {
            display: none;
            padding: 20px;
        }
        
        .page.active {
            display: block;
        }
        
        /* è¨­å®šé æ¨£å¼ */
        .setting-group {
            margin-bottom: 25px;
            padding: 20px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
        }
        
        .setting-title {
            font-size: 1.1rem;
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .group-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .group-btn {
            padding: 12px 16px;
            background: #ecf0f1;
            color: #2c3e50;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
            text-align: center;
        }
        
        .group-btn:hover {
            background: #d5dbdb;
            border-color: #95a5a6;
        }
        
        .group-btn.selected {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        .group-btn.selected:hover {
            background: #2980b9;
        }
        
        .selection-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            color: #495057;
            font-weight: 500;
        }
        
        .number-input {
            width: 100px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: none;
        }
        
        .start-btn {
            width: 100%;
            padding: 15px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .start-btn:hover {
            background: #229954;
        }
        
        .start-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        /* éŸ³è¨Šæº–å‚™é æ¨£å¼ */
        .audio-prep-content {
            text-align: center;
            padding: 40px 20px;
        }
        
        .prep-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .prep-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .prep-description {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.5;
        }
        
        .test-start-btn {
            width: 200px;
            height: 60px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.3rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 16px rgba(231, 76, 60, 0.3);
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .test-start-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(231, 76, 60, 0.4);
        }
        
        .loading-progress {
            display: none;
            margin-top: 20px;
        }
        
        .loading-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .loading-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .loading-text {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* éŸ³è¨Šæº–å‚™é æŒ‰éˆ•å€åŸŸ */
        .audio-prep-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .audio-prep-buttons .test-start-btn {
            flex: 0 0 200px;
        }
        
        .audio-prep-buttons .control-button {
            flex: 0 0 100px;
        }
        
        /* è€ƒè©¦é æ¨£å¼ */
        .exam-content {
            text-align: center;
            padding: 30px 20px;
        }
        
        .progress {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 25px;
            font-weight: 600;
        }
        
        /* ç°¡åŒ–çš„æ™‚é–“è¨ˆæ™‚å™¨æ¨£å¼ */
        .time-counter {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            display: inline-block;
            min-width: 80px;
        }
        
        .time-counter-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e74c3c;
            font-family: 'Courier New', monospace;
            text-align: center;
        }
        
        .play-control {
            margin-bottom: 25px;
        }
        
        .play-button {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #e74c3c;
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 8px 16px rgba(231, 76, 60, 0.3);
            transition: all 0.3s;
            margin: 0 10px;
        }
        
        .play-button:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 24px rgba(231, 76, 60, 0.4);
        }
        
        .play-button.paused {
            background: #27ae60;
        }
        
        .current-word {
            margin-bottom: 20px;
        }
        
        .word-display {
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: bold;
            min-height: 60px;
            display: none;
        }
        
        .word-display.visible {
            display: block;
        }
        
        .toggle-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
        }
        
        .toggle-btn {
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .toggle-btn:hover {
            background: #2980b9;
        }
        
        .toggle-btn.active {
            background: #e67e22;
        }
        
        .navigation-section {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .nav-button {
            padding: 10px 20px;
            background: #9b59b6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .nav-button:hover {
            background: #8e44ad;
        }
        
        .nav-button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        .control-section {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .control-button {
            padding: 10px 20px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .control-button:hover {
            background: #7f8c8d;
        }
        
        /* ç­”æ¡ˆé æ¨£å¼ */
        .answer-list {
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .answer-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            gap: 15px;
        }
        
        .answer-number {
            width: 40px;
            text-align: center;
            font-weight: bold;
            color: #3498db;
        }
        
        .answer-word {
            flex: 2;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .answer-group {
            flex: 1;
            color: #666;
            font-size: 0.9rem;
        }
        
        .answer-id {
            flex: 0.5;
            color: #666;
            font-size: 0.8rem;
            text-align: center;
        }
        
        .answer-pos {
            flex: 1;
            color: #666;
            font-style: italic;
            font-size: 0.9rem;
        }
        
        .retry-btn {
            width: 100%;
            padding: 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .retry-btn:hover {
            background: #2980b9;
        }
        
        .error-message {
            background: #ffe6e6;
            border: 1px solid #ff9999;
            color: #cc0000;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .auto-play-status {
            margin-top: 15px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 4px;
            color: #27ae60;
            font-weight: 500;
        }
        
        .auto-play-status.paused {
            background: #fff3cd;
            color: #856404;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 5px;
                border-radius: 8px;
            }
            
            .page {
                padding: 15px;
            }
            
            .group-buttons {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 8px;
            }
            
            .word-display {
                font-size: 1.5rem;
            }
            
            .play-button {
                width: 80px;
                height: 80px;
                font-size: 1.2rem;
            }
            
            .test-start-btn {
                width: 180px;
                height: 55px;
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ è‹±æ–‡è½å¯«è€ƒè©¦ç³»çµ±</h1>
            <p id="headerSubtitle">æ‰‹æ©Ÿå„ªåŒ–ç‰ˆ</p>
        </div>
        
        <!-- è¨­å®šé  -->
        <div id="settingPage" class="page active">            
            <div class="setting-group">
                <div class="setting-title">ğŸ“š çµ„åˆ¥é¸æ“‡</div>
                <div class="group-buttons" id="groupButtons"></div>
                <div class="selection-info" id="selectionInfo">è«‹é¸æ“‡çµ„åˆ¥</div>
            </div>
            
            <div class="setting-group" id="examSettingsSection" style="display: none;">
                <div class="setting-title">âš™ï¸ è€ƒè©¦è¨­å®š</div>
                
                <div style="margin-bottom: 15px;">
                    <label>è€ƒè©¦é¡Œæ•¸: </label>
                    <input type="number" class="number-input" id="questionCount" min="1" max="999" value="10">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>æ¯å­—æ¯ç§’æ•¸: </label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="letterTime" min="0.5" max="3" step="0.1" value="1.0">
                        <span id="letterTimeValue">1.0s</span>
                    </div>
                </div>
            </div>
            
            <button class="start-btn" id="startPrepBtn" onclick="goToAudioPrep()" disabled>ä¸‹ä¸€æ­¥</button>
        </div>
        
        <!-- éŸ³è¨Šæº–å‚™é  -->
        <div id="audioPrepPage" class="page">
            <div class="audio-prep-content">
                <div class="prep-icon">ğŸµ</div>
                <div class="prep-title">éŸ³è¨Šæº–å‚™</div>
                <div class="prep-description">
                    ç³»çµ±å°‡ç‚ºæ‚¨æº–å‚™è€ƒè©¦éŸ³æª”<br>
                    é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹æ¸¬é©—ä¸¦æ¿€æ´»éŸ³è¨Šç³»çµ±
                </div>
                
                <div class="loading-progress" id="loadingProgress">
                    <div class="loading-bar">
                        <div class="loading-fill" id="loadingFill"></div>
                    </div>
                    <div class="loading-text" id="loadingText">æ­£åœ¨æº–å‚™éŸ³æª”...</div>
                </div>
                
                <div class="audio-prep-buttons">
                    <button class="test-start-btn" id="testStartBtn" onclick="startAudioPreparation()">æ¸¬é©—é–‹å§‹</button>
                    <button class="control-button" onclick="backToSettings()">è¿”å›è¨­å®š</button>
                </div>
            </div>
        </div>
        
        <!-- è€ƒè©¦é  -->
        <div id="examPage" class="page">
            <div class="exam-content">
                <div class="progress" id="examProgress">ç¬¬ 1 é¡Œ / å…± 10 é¡Œ</div>
                
                <div class="time-counter" id="timeCounter">
                    <div class="time-counter-display" id="timeDisplay">0.0s</div>
                </div>
                
                <div class="play-control">
                    <button class="play-button" id="playButton" onclick="toggleAutoPlay()">â¸</button>
                    <div class="auto-play-status" id="autoPlayStatus">è‡ªå‹•æ’­æ”¾ä¸­...</div>
                </div>
                
                <div class="current-word">
                    <div class="word-display" id="wordDisplay"></div>
                </div>
                
                <div class="toggle-buttons">
                    <button class="toggle-btn" id="toggleWordBtn" onclick="toggleWordDisplay()">é¡¯ç¤ºå–®å­—</button>
                </div>
                
                <div class="navigation-section">
                    <button class="nav-button" id="prevBtn" onclick="previousWord()">â¬… ä¸Šä¸€é¡Œ</button>
                    <button class="nav-button" id="nextBtn" onclick="nextWord()">ä¸‹ä¸€é¡Œ â¡</button>
                </div>
                
                <div class="control-section">
                    <button class="control-button" onclick="backToSettings()">è¿”å›è¨­å®š</button>
                </div>
            </div>
        </div>
        
        <!-- ç­”æ¡ˆé  -->
        <div id="answerPage" class="page">
            <div class="setting-title" style="text-align: center; margin-bottom: 20px;">ğŸ“‹ è€ƒè©¦ç­”æ¡ˆ</div>
            <div class="answer-list" id="answerList"></div>
            <button class="retry-btn" onclick="backToSettings()">é‡æ–°é–‹å§‹</button>
        </div>
    </div>

    <!-- å¼•å…¥å¤–éƒ¨è³‡æ–™æª”æ¡ˆ -->
    <script src="vocabulary-data.js"></script>
    
    <script>
        let selectedGroups = new Set();
        let selectedWords = [];
        let examWords = [];
        let currentWordIndex = 0;
        let isAutoPlaying = false;
        let isPaused = false;
        let autoPlayTimer = null;
        let isWordVisible = false;
        
        // éŸ³æª”æ± å’Œè¼‰å…¥ç›¸é—œ
        let audioPool = {};
        let audioLoadPromises = [];
        let totalAudioFiles = 0;
        let loadedAudioFiles = 0;
        let currentPlayingAudio = null;
        let isPlayingWord = false;
        let wordTimer = null;
        let wordStartTime = 0;
        let wordTotalTime = 0;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeGroupButtons();
            document.getElementById('letterTime').addEventListener('input', updateLetterTimeDisplay);
        });
        
        function initializeGroupButtons() {
            const groupButtons = document.getElementById('groupButtons');
            groupButtons.innerHTML = '';
            
            Object.keys(vocabularyData.groups).forEach(groupName => {
                const button = document.createElement('button');
                button.className = 'group-btn';
                button.textContent = groupName;
                button.onclick = () => toggleGroup(groupName, button);
                groupButtons.appendChild(button);
            });
        }
        
        function toggleGroup(groupName, button) {
            if (selectedGroups.has(groupName)) {
                selectedGroups.delete(groupName);
                button.classList.remove('selected');
            } else {
                selectedGroups.add(groupName);
                button.classList.add('selected');
            }
            
            updateSelectionInfo();
            updateStartButton();
        }
        
        function updateSelectionInfo() {
            selectedWords = [];
            selectedGroups.forEach(groupName => {
                const words = vocabularyData.groups[groupName];
                // ç‚ºæ¯å€‹å–®å­—æ·»åŠ groupè³‡è¨Š
                const wordsWithGroup = words.map(word => ({...word, group: groupName}));
                selectedWords = selectedWords.concat(wordsWithGroup);
            });
            
            const selectionInfo = document.getElementById('selectionInfo');
            const questionCount = document.getElementById('questionCount');
            
            if (selectedWords.length > 0) {
                selectionInfo.textContent = `å·²é¸æ“‡ ${selectedGroups.size} å€‹çµ„åˆ¥ï¼Œå…± ${selectedWords.length} å€‹å–®å­—`;
                questionCount.value = selectedWords.length;
                questionCount.max = selectedWords.length;
                document.getElementById('examSettingsSection').style.display = 'block';
            } else {
                selectionInfo.textContent = 'è«‹é¸æ“‡çµ„åˆ¥';
                document.getElementById('examSettingsSection').style.display = 'none';
            }
        }
        
        function updateStartButton() {
            const canStart = selectedWords.length > 0;
            document.getElementById('startPrepBtn').disabled = !canStart;
        }
        
        function updateLetterTimeDisplay() {
            const value = document.getElementById('letterTime').value;
            document.getElementById('letterTimeValue').textContent = `${value}s`;
        }
        
        function goToAudioPrep() {
            const questionCount = parseInt(document.getElementById('questionCount').value);
            
            // ç¢ºä¿é¡Œæ•¸ä¸è¶…éå¯ç”¨å–®å­—æ•¸
            const actualQuestionCount = Math.min(questionCount, selectedWords.length);
            
            // éš¨æ©Ÿé¸å–å–®å­—
            examWords = [];
            const availableWords = [...selectedWords];
            
            // æ­£ç¢ºçš„éš¨æ©Ÿé¸å–é‚è¼¯
            for (let i = 0; i < actualQuestionCount; i++) {
                if (availableWords.length === 0) break;
                const randomIndex = Math.floor(Math.random() * availableWords.length);
                examWords.push(availableWords.splice(randomIndex, 1)[0]);
            }
            
            console.log(`è¨­å®šé¡Œæ•¸: ${questionCount}, å¯¦éš›é¡Œæ•¸: ${examWords.length}`);
            
            // åˆ‡æ›åˆ°éŸ³è¨Šæº–å‚™é 
            document.getElementById('settingPage').classList.remove('active');
            document.getElementById('audioPrepPage').classList.add('active');
            document.getElementById('headerSubtitle').textContent = 'éŸ³è¨Šæº–å‚™ä¸­...';
        }
        
        async function startAudioPreparation() {
            const testStartBtn = document.getElementById('testStartBtn');
            const loadingProgress = document.getElementById('loadingProgress');
            const loadingFill = document.getElementById('loadingFill');
            const loadingText = document.getElementById('loadingText');
            
            // éš±è—æŒ‰éˆ•ï¼Œé¡¯ç¤ºè¼‰å…¥é€²åº¦
            testStartBtn.style.display = 'none';
            loadingProgress.style.display = 'block';
            
            // æ¿€æ´»éŸ³è¨Šä¸Šä¸‹æ–‡ï¼ˆé‡è¦ï¼ï¼‰
            try {
                // å‰µå»ºä¸€å€‹çŸ­æš«çš„éœéŸ³éŸ³æª”ä¾†æ¿€æ´»éŸ³è¨Šä¸Šä¸‹æ–‡
                const silentAudio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBDuY3PLPeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBDuY3PLPeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBDuY3PLPeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBDuY3PLPeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBDuY3PLPeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBDuY3PLPeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBDuY3PLPeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBDuY3PLPeSwF');
                await silentAudio.play();
                silentAudio.pause();
            } catch (e) {
                console.log('ç„¡æ³•æ¿€æ´»éŸ³è¨Šä¸Šä¸‹æ–‡ï¼Œä½†æœƒç¹¼çºŒå˜—è©¦');
            }
            
            // è¨ˆç®—éœ€è¦è¼‰å…¥çš„éŸ³æª”ç¸½æ•¸
            totalAudioFiles = 0;
            examWords.forEach(word => {
                if (word.us_audio && word.us_audio !== 'N/A') totalAudioFiles++;
                if (word.natural_audio && word.natural_audio !== 'N/A') totalAudioFiles++;
            });
            
            loadedAudioFiles = 0;
            audioPool = {};
            audioLoadPromises = [];
            
            // é–‹å§‹é è¼‰å…¥æ‰€æœ‰éŸ³æª”
            for (let i = 0; i < examWords.length; i++) {
                const word = examWords[i];
                audioPool[i] = {};
                
                // è¼‰å…¥ç¾å¼ç™¼éŸ³
                if (word.us_audio && word.us_audio !== 'N/A') {
                    audioLoadPromises.push(loadAudioFile(word.us_audio, i, 'us'));
                }
                
                // è¼‰å…¥è‡ªç„¶ç™¼éŸ³
                if (word.natural_audio && word.natural_audio !== 'N/A') {
                    audioLoadPromises.push(loadAudioFile(word.natural_audio, i, 'natural'));
                }
            }
            
            try {
                // ç­‰å¾…æ‰€æœ‰éŸ³æª”è¼‰å…¥å®Œæˆ
                await Promise.allSettled(audioLoadPromises);
                
                loadingFill.style.width = '100%';
                loadingText.textContent = 'æº–å‚™å®Œæˆï¼';
                
                // ç­‰å¾…ä¸€ä¸‹ç„¶å¾Œé€²å…¥è€ƒè©¦
                setTimeout(() => {
                    startExam();
                }, 500);
                
            } catch (error) {
                console.error('éŸ³æª”è¼‰å…¥éç¨‹ä¸­å‡ºç¾éŒ¯èª¤:', error);
                loadingText.textContent = 'æº–å‚™å®Œæˆï¼ˆéƒ¨åˆ†éŸ³æª”å¯èƒ½ç„¡æ³•è¼‰å…¥ï¼‰';
                
                setTimeout(() => {
                    startExam();
                }, 1000);
            }
        }
        
        function loadAudioFile(url, wordIndex, audioType) {
            return new Promise((resolve, reject) => {
                const audio = new Audio();
                
                audio.addEventListener('canplaythrough', () => {
                    loadedAudioFiles++;
                    updateLoadingProgress();
                    resolve();
                });
                
                audio.addEventListener('error', (e) => {
                    console.warn(`éŸ³æª”è¼‰å…¥å¤±æ•—: ${url}`, e);
                    loadedAudioFiles++;
                    updateLoadingProgress();
                    resolve(); // å³ä½¿å¤±æ•—ä¹Ÿç¹¼çºŒ
                });
                
                audio.preload = 'auto';
                audio.src = url;
                audioPool[wordIndex][audioType] = audio;
            });
        }
        
        function updateLoadingProgress() {
            const progress = (loadedAudioFiles / totalAudioFiles) * 100;
            const loadingFill = document.getElementById('loadingFill');
            const loadingText = document.getElementById('loadingText');
            
            loadingFill.style.width = `${progress}%`;
            loadingText.textContent = `æ­£åœ¨æº–å‚™éŸ³æª”... (${loadedAudioFiles}/${totalAudioFiles})`;
        }
        
        function startExam() {
            currentWordIndex = 0;
            isWordVisible = false;
            
            // åˆ‡æ›åˆ°è€ƒè©¦é 
            document.getElementById('audioPrepPage').classList.remove('active');
            document.getElementById('examPage').classList.add('active');
            document.getElementById('headerSubtitle').textContent = 'è½å¯«ä¸­...';
            
            // é‡ç½®é¡¯ç¤ºç‹€æ…‹
            document.getElementById('wordDisplay').classList.remove('visible');
            document.getElementById('toggleWordBtn').classList.remove('active');
            document.getElementById('toggleWordBtn').textContent = 'é¡¯ç¤ºå–®å­—';
            
            loadCurrentWord();
            startAutoPlay();
        }
        
        function loadCurrentWord() {
            if (currentWordIndex >= examWords.length) {
                stopAutoPlay();
                showAnswers();
                return;
            }
            
            const word = examWords[currentWordIndex];
            const progress = document.getElementById('examProgress');
            progress.textContent = `ç¬¬ ${currentWordIndex + 1} é¡Œ / å…± ${examWords.length} é¡Œ`;
            
            document.getElementById('wordDisplay').textContent = word.word;
            
            // æ›´æ–°å°èˆªæŒ‰éˆ•ç‹€æ…‹
            document.getElementById('prevBtn').disabled = currentWordIndex === 0;
            document.getElementById('nextBtn').disabled = currentWordIndex === examWords.length - 1;
            
            // å¦‚æœå–®å­—é¡¯ç¤ºç‹€æ…‹æ˜¯é–‹å•Ÿçš„ï¼Œç¢ºä¿é¡¯ç¤º
            if (isWordVisible) {
                document.getElementById('wordDisplay').classList.add('visible');
            }
            
            // æ™‚é–“è¨ˆæ™‚å™¨æœƒåœ¨startWordTimeræ™‚è‡ªå‹•æ›´æ–°
        }
        
        async function startAutoPlay() {
            isAutoPlaying = true;
            isPaused = false;
            updatePlayButton();
            updateAutoPlayStatus();
            
            await playCurrentWordLoop();
        }
        
        async function playCurrentWordLoop() {
            // åš´æ ¼æª¢æŸ¥ç‹€æ…‹ï¼Œé¿å…é‡è¤‡åŸ·è¡Œ
            if (!isAutoPlaying || isPaused || currentWordIndex >= examWords.length || isPlayingWord) {
                return;
            }
            
            isPlayingWord = true;
            
            // é–‹å§‹æ™‚é–“è¨ˆæ™‚å™¨
            startWordTimer();
            
            try {
                await playCurrentWordFromPool();
                
                // æ’­æ”¾å®Œæˆå¾Œæª¢æŸ¥ç‹€æ…‹
                if (isAutoPlaying && !isPaused && isPlayingWord) {
                    // å–®å­—ç¸½æ’­æ”¾æ™‚é–“ = æ¯å­—æ¯ç§’æ•¸ Ã— å–®å­—å­—æ¯æ•¸ï¼ˆåŒ…å«éŸ³æª”æ’­æ”¾å’Œé–“éš”ï¼‰
                    const word = examWords[currentWordIndex];
                    const letterTime = parseFloat(document.getElementById('letterTime').value);
                    const totalWordTime = word.word.length * letterTime * 1000;
                    
                    autoPlayTimer = setTimeout(() => {
                        if (isAutoPlaying && !isPaused && isPlayingWord) {
                            isPlayingWord = false;
                            currentWordIndex++;
                            loadCurrentWord();
                            playCurrentWordLoop();
                        }
                    }, totalWordTime);
                } else {
                    isPlayingWord = false;
                }
            } catch (error) {
                console.error('æ’­æ”¾éŒ¯èª¤:', error);
                showError('éŸ³æª”æ’­æ”¾ç•°å¸¸ï¼Œè·³åˆ°ä¸‹ä¸€é¡Œ');
                // å³ä½¿å‡ºéŒ¯ä¹Ÿç¹¼çºŒä¸‹ä¸€é¡Œ
                autoPlayTimer = setTimeout(() => {
                    if (isAutoPlaying && !isPaused && isPlayingWord) {
                        isPlayingWord = false;
                        currentWordIndex++;
                        loadCurrentWord();
                        playCurrentWordLoop();
                    }
                }, 2000); // ä¿æŒä¸€è‡´çš„é–“éš”
            }
        }
        
        async function playCurrentWordFromPool() {
            const wordIndex = currentWordIndex;
            const word = examWords[wordIndex];
            const letterTime = parseFloat(document.getElementById('letterTime').value);
            const wordInterval = word.word.length * letterTime * 1000;
            
            const audioQueue = [];
            
            // å¾éŸ³æª”æ± ä¸­å–å¾—éŸ³æª”
            if (audioPool[wordIndex] && audioPool[wordIndex].us) {
                audioQueue.push(audioPool[wordIndex].us);
            }
            
            if (audioPool[wordIndex] && audioPool[wordIndex].natural) {
                audioQueue.push(audioPool[wordIndex].natural);
            }
            
            if (audioQueue.length === 0) {
                throw new Error('ç„¡å¯ç”¨éŸ³æª”');
            }
            
            // ä¾åºæ’­æ”¾éŸ³æª”
            for (let i = 0; i < audioQueue.length; i++) {
                if (!isAutoPlaying || isPaused) break;
                
                await playAudioFromPool(audioQueue[i]);
                
                if (i < audioQueue.length - 1 && isAutoPlaying && !isPaused) {
                    await sleep(1000); // 1ç§’é–“éš”
                }
            }
            
            // ç§»é™¤é¡å¤–çš„wordIntervalç­‰å¾…ï¼Œä½¿é–“éš”æ›´ä¸€è‡´
            // ç¾åœ¨å–®ç´”ä¾è³´playCurrentWordLoopä¸­çš„2ç§’é–“éš”
        }
        
        function playAudioFromPool(audioElement) {
            return new Promise((resolve, reject) => {
                if (!audioElement) {
                    reject(new Error('éŸ³æª”ä¸å­˜åœ¨'));
                    return;
                }
                
                // åœæ­¢ä¹‹å‰çš„æ’­æ”¾
                if (currentPlayingAudio && currentPlayingAudio !== audioElement) {
                    currentPlayingAudio.pause();
                }
                
                currentPlayingAudio = audioElement;
                audioElement.currentTime = 0; // é‡ç½®æ’­æ”¾ä½ç½®
                
                audioElement.onended = () => {
                    currentPlayingAudio = null;
                    resolve();
                };
                audioElement.onerror = () => {
                    currentPlayingAudio = null;
                    reject(new Error('éŸ³æª”æ’­æ”¾å¤±æ•—'));
                };
                
                audioElement.play().catch(err => {
                    currentPlayingAudio = null;
                    reject(err);
                });
            });
        }
        
        function toggleAutoPlay() {
            if (!isAutoPlaying) {
                startAutoPlay();
            } else {
                if (isPaused) {
                    resumeAutoPlay();
                } else {
                    pauseAutoPlay();
                }
            }
        }
        
        function pauseAutoPlay() {
            isPaused = true;
            stopCurrentPlayback();
            updatePlayButton();
            updateAutoPlayStatus();
        }
        
        function resumeAutoPlay() {
            isPaused = false;
            updatePlayButton();
            updateAutoPlayStatus();
            playCurrentWordLoop();
        }
        
        function stopAutoPlay() {
            isAutoPlaying = false;
            isPaused = false;
            stopCurrentPlayback();
            updatePlayButton();
            updateAutoPlayStatus();
        }
        
        function stopCurrentPlayback() {
            // æ¸…ç†æ‰€æœ‰æ’­æ”¾ç‹€æ…‹
            clearTimeout(autoPlayTimer);
            stopWordTimer();
            isPlayingWord = false;
            
            // åœæ­¢ç•¶å‰æ’­æ”¾çš„éŸ³æª”
            if (currentPlayingAudio) {
                currentPlayingAudio.pause();
                currentPlayingAudio.currentTime = 0;
                currentPlayingAudio = null;
            }
            
            // åœæ­¢æ‰€æœ‰å¯èƒ½æ­£åœ¨æ’­æ”¾çš„éŸ³æª”
            Object.values(audioPool).forEach(wordAudioSet => {
                Object.values(wordAudioSet).forEach(audio => {
                    if (audio && !audio.paused) {
                        audio.pause();
                        audio.currentTime = 0;
                    }
                });
            });
        }
        
        function updatePlayButton() {
            const playButton = document.getElementById('playButton');
            if (!isAutoPlaying) {
                playButton.textContent = 'â–¶';
                playButton.classList.remove('paused');
            } else if (isPaused) {
                playButton.textContent = 'â–¶';
                playButton.classList.add('paused');
            } else {
                playButton.textContent = 'â¸';
                playButton.classList.remove('paused');
            }
        }
        
        function updateAutoPlayStatus() {
            const statusElement = document.getElementById('autoPlayStatus');
            if (!isAutoPlaying) {
                statusElement.textContent = 'å·²åœæ­¢';
                statusElement.classList.add('paused');
            } else if (isPaused) {
                statusElement.textContent = 'å·²æš«åœ';
                statusElement.classList.add('paused');
            } else {
                statusElement.textContent = 'è‡ªå‹•æ’­æ”¾ä¸­...';
                statusElement.classList.remove('paused');
            }
        }
        
        function previousWord() {
            if (currentWordIndex > 0) {
                // å®Œå…¨åœæ­¢ç•¶å‰æ’­æ”¾
                stopCurrentPlayback();
                
                currentWordIndex--;
                loadCurrentWord();
                
                if (isAutoPlaying && !isPaused) {
                    // ç¨å¾®å»¶é²å¾Œé‡æ–°é–‹å§‹æ’­æ”¾ï¼Œç¢ºä¿ç‹€æ…‹æ¸…ç†å®Œæˆ
                    setTimeout(() => {
                        if (isAutoPlaying && !isPaused) {
                            playCurrentWordLoop();
                        }
                    }, 100);
                }
            }
        }
        
        function nextWord() {
            if (currentWordIndex < examWords.length - 1) {
                // å®Œå…¨åœæ­¢ç•¶å‰æ’­æ”¾
                stopCurrentPlayback();
                
                currentWordIndex++;
                loadCurrentWord();
                
                if (isAutoPlaying && !isPaused) {
                    // ç¨å¾®å»¶é²å¾Œé‡æ–°é–‹å§‹æ’­æ”¾ï¼Œç¢ºä¿ç‹€æ…‹æ¸…ç†å®Œæˆ
                    setTimeout(() => {
                        if (isAutoPlaying && !isPaused) {
                            playCurrentWordLoop();
                        }
                    }, 100);
                }
            } else {
                // æœ€å¾Œä¸€é¡Œï¼ŒçµæŸè€ƒè©¦
                stopAutoPlay();
                showAnswers();
            }
        }
        
        function toggleWordDisplay() {
            const wordDisplay = document.getElementById('wordDisplay');
            const toggleBtn = document.getElementById('toggleWordBtn');
            
            isWordVisible = !isWordVisible;
            
            if (isWordVisible) {
                wordDisplay.classList.add('visible');
                toggleBtn.classList.add('active');
                toggleBtn.textContent = 'éš±è—å–®å­—';
            } else {
                wordDisplay.classList.remove('visible');
                toggleBtn.classList.remove('active');
                toggleBtn.textContent = 'é¡¯ç¤ºå–®å­—';
            }
        }
        
        function showAnswers() {
            document.getElementById('examPage').classList.remove('active');
            document.getElementById('answerPage').classList.add('active');
            document.getElementById('headerSubtitle').textContent = 'è€ƒè©¦çµæœ';
            
            const answerList = document.getElementById('answerList');
            answerList.innerHTML = '';
            
            examWords.forEach((word, index) => {
                const answerItem = document.createElement('div');
                answerItem.className = 'answer-item';
                
                answerItem.innerHTML = `
                    <div class="answer-number">${index + 1}</div>
                    <div class="answer-word">${word.word}</div>
                    <div class="answer-group">${word.group}</div>
                    <div class="answer-id">${word.id}</div>
                    <div class="answer-pos">${word.pos}</div>
                `;
                
                answerList.appendChild(answerItem);
            });
        }
        
        function backToSettings() {
            stopAutoPlay();
            
            document.getElementById('examPage').classList.remove('active');
            document.getElementById('answerPage').classList.remove('active');
            document.getElementById('audioPrepPage').classList.remove('active');
            document.getElementById('settingPage').classList.add('active');
            document.getElementById('headerSubtitle').textContent = 'æ‰‹æ©Ÿå„ªåŒ–ç‰ˆ';
            
            // é‡ç½®ç‹€æ…‹
            currentWordIndex = 0;
            isWordVisible = false;
            examWords = [];
            audioPool = {};
            currentPlayingAudio = null;
            isPlayingWord = false;
            
            // å®Œå…¨é‡ç½®çµ„åˆ¥é¸æ“‡ç‹€æ…‹ï¼ˆä¿æŒä¸€è‡´çš„ä»‹é¢ï¼‰
            selectedGroups.clear();
            selectedWords = [];
            
            // é‡æ–°åˆå§‹åŒ–ç¾¤çµ„æŒ‰éˆ•
            initializeGroupButtons();
            
            // é‡ç½®é¡¯ç¤ºç‹€æ…‹
            document.getElementById('selectionInfo').textContent = 'è«‹é¸æ“‡çµ„åˆ¥';
            document.getElementById('examSettingsSection').style.display = 'none';
            document.getElementById('startPrepBtn').disabled = true;
            
            // é‡ç½®éŸ³è¨Šæº–å‚™é é¢
            document.getElementById('testStartBtn').style.display = 'block';
            document.getElementById('loadingProgress').style.display = 'none';
            document.getElementById('loadingFill').style.width = '0%';
            document.getElementById('loadingText').textContent = 'æ­£åœ¨æº–å‚™éŸ³æª”...';
        }
        
        function showError(message) {
            const progress = document.getElementById('examProgress');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            progress.parentNode.insertBefore(errorDiv, progress.nextSibling);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 3000);
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // æ™‚é–“è¨ˆæ™‚å™¨ç›¸é—œå‡½æ•¸
        function startWordTimer() {
            const word = examWords[currentWordIndex];
            const letterTime = parseFloat(document.getElementById('letterTime').value);
            wordTotalTime = word.word.length * letterTime * 1000; // æ¯«ç§’
            wordStartTime = Date.now();
            
            // ç«‹å³æ›´æ–°ä¸€æ¬¡é¡¯ç¤º
            updateTimeDisplay();
            
            // æ¯100æ¯«ç§’æ›´æ–°ä¸€æ¬¡é¡¯ç¤º
            wordTimer = setInterval(updateTimeDisplay, 100);
        }
        
        function stopWordTimer() {
            if (wordTimer) {
                clearInterval(wordTimer);
                wordTimer = null;
            }
        }
        
        function updateTimeDisplay() {
            if (!isPlayingWord || currentWordIndex >= examWords.length) {
                document.getElementById('timeDisplay').textContent = '0.0s';
                return;
            }
            
            const elapsed = Date.now() - wordStartTime;
            const remaining = Math.max(0, wordTotalTime - elapsed);
            const remainingSeconds = (remaining / 1000).toFixed(1);
            
            document.getElementById('timeDisplay').textContent = `${remainingSeconds}s`;
            
            // æ ¹æ“šå‰©é¤˜æ™‚é–“æ”¹è®Šé¡è‰²
            const timeDisplay = document.getElementById('timeDisplay');
            const percentage = remaining / wordTotalTime;
            
            if (percentage > 0.5) {
                timeDisplay.style.color = '#27ae60'; // ç¶ è‰²
            } else if (percentage > 0.25) {
                timeDisplay.style.color = '#f39c12'; // æ©™è‰²
            } else {
                timeDisplay.style.color = '#e74c3c'; // ç´…è‰²
            }
        }
        
        // ç§»é™¤å¤šé¤˜çš„è³‡è¨Šé¡¯ç¤ºå‡½æ•¸ï¼Œåªä¿ç•™ç°¡æ½”çš„å€’æ•¸è¨ˆæ™‚
    </script>
</body>
</html>